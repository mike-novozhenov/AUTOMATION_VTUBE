name: Scheduled Health Check

on:
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch:

jobs:
  health-check-job:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Availability and Speed Test
        run: |
          # –°–Ω–∞—á–∞–ª–∞ –∑–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã, –∏–≥–Ω–æ—Ä–∏—Ä—É—è –∏—Ö –ø–∞–¥–µ–Ω–∏–µ –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è —à–∞–≥–æ–≤
          pytest tests/cron_tests/test_health.py || true
          # –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –Ω–∞–ª–∏—á–∏–µ –ø–∞–ø–∫–∏ –∏ –∫–æ–ø–∏—Ä—É–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
          mkdir -p allure-results
          cp categories.json allure-results/ || echo "categories.json missing"
          ls -l allure-results/
        continue-on-error: true

      - name: Generate Allure Report
        uses: simple-elf/allure-report-action@master
        if: always()
        with:
          allure_results: allure-results
          allure_report: allure-report
          gh_pages: gh-pages
          keep_reports: 20

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        if: always()
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./allure-report

      # - name: Send Telegram Notification
      #   # –ó–∞–º–µ–Ω–∏–ª–∏ —É–ø–∞–≤—à–∏–π —ç–∫—à–µ–Ω –Ω–∞ —Å—Ç–∞–±–∏–ª—å–Ω—ã–π appleboy
      #   uses: appleboy/telegram-action@master
      #   if: always()
      #   with:
      #     to: ${{ secrets.TELEGRAM_CHAT_ID }}
      #     token: ${{ secrets.TELEGRAM_TOKEN }}
      #     message: |
      #       üöÄ Health Check Completed!
      #       Status: ${{ job.status }}
      #       Project: ${{ github.repository }}
            
      #       Report: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/